{% extends "index.html" %}
<!-- 编辑蒙版页面 -->
{% block head %}
    <title>Modify Mask</title>
    <style>
        /* 测试可以先写在这里面 */
    </style>
    <!-- css文件存储在static/css下，通过下面的方式调用 -->
    <!-- <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/layout.css') }}"> -->
{% endblock %}
{% block workplace %}
    <img id="source" src="{{ image }}" alt="source" style="position:absolute; top: 0px; left: 0px;">
    <img id="mask" src="{{ mask }}" alt="source" style="position:absolute; top: 0px; left: 0px; display: none;">
    <canvas id="maskedit" style="position:absolute;  top: 0px; left: 0px; opacity: 0.4;"></canvas>
{% endblock %}
{% block menu %}
    <select id="linewidth">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25" selected="selected">25</option>
        <option value="30">30</option>
    </select>
    <button id="mode" value="pen" onclick="mode_change()">Mode</button>
    <form action="/result" method="POST" onsubmit="convert()">
        <button id="generate" name="maskgen" type="submit">Generate</button>
    </form>
{% endblock %}
{% block bodyscript %}
    <script>
        $(document).ready(function () {
            var mousePressed = false;
            var lastX, lastY;
            var ctx;
            InitThis();
        });

        function InitThis() {
            ctx = document.getElementById('maskedit').getContext("2d");
            $('#workplace').css("width", "{{ width }}").css("height", "{{ height }}");
            $('#maskedit').attr("width", "{{ width }}").attr("height", "{{ height }}");
            ctx.drawImage(document.getElementById("mask"),0,0);

            $('#maskedit').mousedown(function (e) {
                mousePressed = true;
                if($("#mode").val()=="pen"){
                    Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
                }
                else{
                    Erase(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
                }
            });

            $('#maskedit').mousemove(function (e) {
                if (mousePressed) {
                    if($("#mode").val()=="pen"){
                        Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
                    }
                    else{
                        Erase(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
                    }
                }
            });

            $('#maskedit').mouseup(function (e) {
                mousePressed = false;
            });
            $('#maskedit').mouseleave(function (e) {
                mousePressed = false;
            });
        }

        function Draw(x, y, isDown) {
            if (isDown) {
                ctx.beginPath();
                ctx.strokeStyle = "#FF0000";
                ctx.lineWidth = $("#linewidth").val();
                ctx.lineJoin = "round";
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.stroke();
            }
            lastX = x; lastY = y;
        }

        function Erase(x, y, isDown) {
            if (isDown) {
                var width = $("#linewidth").val();
                var half = Math.floor(width / 2);
                ctx.clearRect(x-half, y-half, width, width);
            }
            lastX = x; lastY = y;
        }

        function clearArea() {
            // Use the identity matrix while clearing the canvas
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

        function mode_change() {
            var mode = document.getElementById("mode");
            if(mode.getAttribute("value")=="pen"){
                mode.setAttribute("value", "eraser");
            }
            else{
                mode.setAttribute("value", "pen");
            }
        }

        function convert() {
            $("#generate").attr("value", document.getElementById("maskedit").toDataURL("image/jpeg"));
        }
    </script>
    {% endblock %}